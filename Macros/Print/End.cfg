[gcode_macro END_PRINT]
description: End Print and filter the atmosphere for type of filamnet before shuting down
gcode:
  {% set filament = params.FILAMENT|default("XXX")|string %}
  {% set unload = params.UNLOAD_AT_END|default(0)|int %}

  SET_FILAMENT_SENSOR SENSOR=encoder_sensor ENABLE=0
  M400 ; Wait for current moves to finish
  PARK E=5 ; Park Toolhead and Retract Filament
  STOP_LED_EFFECTS FADETIME=2.0
  SET_LED_EFFECT EFFECT=BED_HEATING
  TURN_OFF_HEATERS
  {% if unload|int == 1 %}
    ERCF_EJECT
  {% endif %}
  BED_MESH_CLEAR
  M84 ; Turn Motors OFF

  {% if filament == 'ASA' %}
    M106 S 200
    SET_FAN_SPEED FAN=Filter SPEED=1.0
    G4 P{60000 * 2}
  {% elif filament == 'ABS' %}
    M106 S 200
    SET_FAN_SPEED FAN=Filter SPEED=1.0
    G4 P{60000 * 2}
  {% elif filament == 'PC' %}
    M106 S 200
    SET_FAN_SPEED FAN=Filter SPEED=1.0
    G4 P{60000 * 1}
  {% elif filament == 'NYLON' %}
    M106 S 200
    SET_FAN_SPEED FAN=Filter SPEED=1.0
    G4 P{60000 * 2}
  {% endif %}

  Fans_Off
  STOP_LED_EFFECTS FADETIME=2.0
  SET_LED_EFFECT EFFECT=BLUE FADETIME=2.0
  SET_PIN PIN=LED_Bar VALUE=1.0