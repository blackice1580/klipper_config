[gcode_macro START_PRINT]
description: Machine heatup procedure before starting a print
gcode:
    # Extruder and bed temperatures
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(190)|float %}
    # Default material type to 'XXX'
    {% set MATERIAL = params.MATERIAL|default("XXX")|string %}
    # Get bounding box of the first layer
    {% set FL_SIZE = params.SIZE|default("0_0_0_0")|string %}

    # Set vars
    _User_Variables
    {% set V = printer["gcode_macro _User_Variables"].verbose %}
    {% set St = printer["gcode_macro _User_Variables"].travel_speed * 60 %}
    {% set Px = printer["gcode_macro _User_Variables"].purge_bucket_x %}
    {% set Py = printer["gcode_macro _User_Variables"].purge_bucket_y %}
    {% set Pz = printer["gcode_macro _User_Variables"].purge_bucket_z %}

    {% set max_x = printer.toolhead.axis_maximum.x|float %}
    {% set max_y = printer.toolhead.axis_maximum.y|float %}

    CLEAR_PAUSE
    BED_MESH_CLEAR
    G90
    M83
    STOP_LED_EFFECTS                         ; Stop all led_effects
    SET_PIN PIN=LED_Bar VALUE=0.5            ; Set led_bar to off
    #SET_GCODE_OFFSET Z_ADJUST={params.Z_ADJUST|default(0.0)|float} MOVE=1 ; Adjust Auto-Z offset if needed from slicer

    # 1 ----- BED HEATING ------------------------------------------
    SET_LED_EFFECT EFFECT=BED_HEATING        ; Set led_effect bed
    M140 S{BED_TEMP}                         ; Start bed heating

    # 2 ----- HOMING ------------------------------------------
    # Home if not already homed and park the head near the center front
    {% if not 'xyz' in printer.toolhead.homed_axes %}
        G28
    {% endif %}
    G0 X{max_x|int / 2} Y{max_y|int / 3} Z50 F{St}

    ## 3 ----- AUTO Z CALIBRATION --------------------------------
    ## We first do a purge of the filament into the purge bucket to be ready to print
    ## Then toolhead go for a quick cleaning of the nozzle tip before doing the Z calibration procedure.
    ## For the auto Z calibration, we measure the nozzle height using the physical Z endstop probe, followed by
    ## a measurement of the Klicky probe on the physical Z endstop probe, and then a measurement of the center of the bed.
    #M109 S140
    #{% if V %}
    #    RESPOND MSG="Nozzle cleaning..."
    #{% endif %}
    #CLEAN_NOZZLE
    {% if V %}
        RESPOND MSG="Calibrating Z-offset..."
    {% endif %}
    #G28 Z
    CALIBRATE_Z

    # 4 ----- EXTRUDER HEATING ---------------------------------
    # Heat the nozzle to print temperature ontop of the purge bucket
    SET_LED_EFFECT EFFECT=NOZZLE_HEATING     ; Set led_effect
    G1 X{Px} Y{Py} Z{Pz|int + 20} F{St}
    M109 S{EXTRUDER_TEMP}
    {% if V %}
        RESPOND MSG="Extruder temperature OK"
    {% endif %}
    SET_LED_EFFECT EFFECT=NOZZLE_HEATING STOP=1
    NOZZLE_LED_ON                       ; Set nozzle led to on
    {% if V %}
        RESPOND MSG="Purge filament..."
    {% endif %}
    PURGE TEMP={EXTRUDER_TEMP}
    {% if V %}
        RESPOND MSG="Nozzle cleaning..."
    {% endif %}
    CLEAN_NOZZLE

    # 5 ----- BED MESH -------------------------------------------
    M190 S{BED_TEMP}                    ; Wait for bed to reach temperature
    SET_LED_EFFECT EFFECT=BED_HEATING STOP=1
    #{% if V %}
    #    RESPOND MSG="Bed mesh measurement..."
    #{% endif %}
    #ADAPTIVE_BED_MESH SIZE={FL_SIZE}
    #DOCK_PROBE_UNLOCK


    # 6 ----- PRINT !!! -------------------------------------------
    # Do a prime line, lower the lights and start the print
    {% if V %}
        RESPOND MSG="Start printing !"
    {% endif %}
    #PRIME_LINE
    SET_PIN PIN=LED_Bar VALUE=0.20      ; Set led_bar
    G92 E0.0